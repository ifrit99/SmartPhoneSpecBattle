# SPEC BATTLE - 仕様書

バージョン: 0.1.0
最終更新: 2026-02-17

---

## 1. 概要

SPEC BATTLEは、スマートフォンのデバイススペック（OSバージョン、CPUコア数、RAM容量、ストレージ、バッテリー残量）を解析し、その情報に基づいてキャラクターを自動生成して戦わせるFlutter製の対戦RPGゲームである。

同一端末からは常に同じキャラクターが生成されるため、「世界に1体だけの自分のキャラクター」という体験を提供する。

---

## 2. 対応プラットフォーム

| プラットフォーム | 対応状況 | デバイス情報取得 |
|---|---|---|
| Android | 対応 | `dart:io` Platform API |
| iOS | 対応 | `dart:io` Platform API |
| Web | 対応 | スタブ実装（固定値） |

### プラットフォーム差分の吸収

条件付きインポート (`conditional import`) により、Web環境とネイティブ環境のコードを分離している。

- **ネイティブ** (`platform_info_native.dart`): `dart:io` の `Platform` クラスを使用し、OSバージョン・デバイスモデル・CPUコア数を取得
- **Web** (`platform_info_stub.dart`): 固定値を返すスタブ実装（OSバージョン: "Web"、CPUコア数: 4）

バッテリー情報は `battery_plus` パッケージで取得し、取得失敗時（Web・シミュレータ含む）は100%とする。

---

## 3. 画面構成

アプリは以下の4画面で構成される。

### 3.1 ホーム画面 (`HomeScreen`)

アプリ起動時の画面。以下の要素を表示する。

- **タイトル**: 「SPEC BATTLE」
- **バッテリーインジケーター**: 現在のバッテリー残量とSPD補正値を表示
- **キャラクターカード**: プレイヤーキャラクターのドット絵・名前・属性・レベル・HP・EXP・SPDを表示。タップでキャラクター詳細画面へ遷移
- **戦績カード**: バトル数・勝利数・勝率を表示
- **バトル開始ボタン**: パルスアニメーション付き。タップでバトル画面へ遷移

バッテリー残量は30秒間隔でポーリングし、リアルタイムに反映する。

### 3.2 キャラクター詳細画面 (`CharacterScreen`)

キャラクターの詳細情報を表示する。

- キャラクタードット絵（大サイズ: 160px）
- 名前・属性・レベル
- ステータスバー（HP/ATK/DEF/SPD）
- スキル一覧（名前・説明・クールダウンターン数）
- 経験値バー

### 3.3 バトル画面 (`BattleScreen`)

ターン制オートバトルをアニメーション付きで表示する。

- **バトルフィールド**: 上部に敵キャラ、下部にプレイヤーキャラを配置。ターン数を中央上部に表示
- **HPバー**: 各キャラクターの現在HPをリアルタイム更新。HP残量に応じて色が変化（緑→橙→赤）
- **バトルログ**: ログエントリを800ms間隔で順次表示（逆順スクロール）
- **演出**: ダメージポップアップ、ヒットシェイク、スキルエフェクトオーバーレイ
- **スキップボタン**: バトル中にタップすると即座に最終結果へスキップ
- **リザルトへボタン**: バトル完了後に表示。タップでリザルト画面へ遷移

### 3.4 リザルト画面 (`ResultScreen`)

バトル結果を表示し、経験値・戦績をローカルストレージに保存する。

- 勝敗アイコンとテキスト（勝利: 金色トロフィー、敗北: 灰色）
- 対決表示（プレイヤー VS 敵のドット絵）
- ターン数・獲得経験値
- ホームに戻るボタン（保存完了を待ってから遷移）

---

## 4. デバイススペック取得

`DeviceInfoService` クラスがデバイス情報の収集を担当する。

### 取得項目

| 項目 | 取得方法 | フォールバック値 |
|---|---|---|
| OSバージョン | `Platform.operatingSystemVersion` | "14.0" |
| デバイスモデル | Platform判定 | "Unknown" |
| CPUコア数 | `Platform.numberOfProcessors` | 4 |
| RAM容量 (MB) | CPUコア数から推定 | 4096 |
| ストレージ空き (GB) | 固定値 | 32 |
| バッテリー残量 (%) | `battery_plus` | 100 |
| 画面サイズ | Widget側から後設定 | 375x812 |

### RAM推定ロジック

直接取得APIがないため、CPUコア数からRAM容量を推定する。

| CPUコア数 | 推定RAM |
|---|---|
| 8以上 | 6144 MB (6GB) |
| 6以上 | 4096 MB (4GB) |
| 4以上 | 3072 MB (3GB) |
| その他 | 2048 MB (2GB) |

### バッテリーモニタリング

`batteryLevelStream` により30秒間隔でバッテリー残量をポーリングし、ストリームとして提供する。ホーム画面がこれを購読し、キャラクターのSPD補正にリアルタイム反映する。

---

## 5. キャラクター生成

`CharacterGenerator` クラスがデバイススペックからキャラクターを生成する。

### 5.1 シード値

デバイススペックの各値を文字列連結し、Dartの `hashCode` でシード値を生成する。

```
seed = "${cpuCores}_${ramMB}_${storageFreeGB}_${screenWidth}_${screenHeight}_${osVersion}".hashCode
```

同じ端末では常に同じシード値が生成され、同じキャラクターとなる。

### 5.2 基礎ステータス計算

| ステータス | 計算式 | 範囲 |
|---|---|---|
| ATK | `cpuCores * 2 + 2` | 8 - 25 |
| HP | `(ramMB / 1024) * 20 + 40` | 60 - 200 |
| DEF | `(storageFreeGB / 8) + 6` | 8 - 25 |
| SPD | `(batteryLevel / 10) + 5` | 8 - 25 |

各ステータスにはランダム要素として -2 ~ +2 の分散値が加算される（シード固定のRandom使用）。

### 5.3 キャラクター名

属性ごとのプレフィックス（4種）とサフィックス（8種）の組み合わせで決定する。

**プレフィックス**:
| 属性 | 候補 |
|---|---|
| 炎 | フレア、イグニス、ブレイズ、バーン |
| 水 | アクア、ウェイブ、タイダル、リップル |
| 地 | テラ、ロック、ガイア、グランド |
| 風 | ゼファー、ブリーズ、ストーム、ガスト |
| 光 | ルミナ、レイ、シャイン、グロウ |
| 闇 | シャドウ、ノクス、ダスク、ヴォイド |

**サフィックス**: ナイト、ガーディアン、ウォリアー、メイジ、スピリット、ファントム、チャンプ、キング

名前形式: `{プレフィックス}・{サフィックス}`（例: フレア・ナイト）

### 5.4 ドット絵ビジュアル

`PixelCharacter` ウィジェットが `CustomPaint` でドット絵風キャラクターを描画する。

以下のパーツインデックス（各0-7）がシードから決定される:
- **頭 (headIndex)**: 4種の形状（丸頭、角張り、とがり、大頭）
- **体 (bodyIndex)**: 横幅が3段階で変化
- **腕 (armIndex)**: 長さが3段階で変化
- **脚 (legIndex)**: 幅が2段階で変化
- **カラーパレット (colorPaletteIndex)**: 6種（赤系、青緑系、黄系、紫系、緑系、ピンク系）

各パーツにはベースカラー・アクセントカラー・シャドウカラーの3色が使用される。体の中央に属性カラーのマークが描画される。

### 5.5 CPU対戦相手の生成

`CharacterGenerator.generateOpponent(playerLevel)` でランダムな対戦相手を生成する。

- 属性: 完全ランダム
- レベル: プレイヤーレベル ± 1（最低1）
- 基礎ステータス: HP 80-139、ATK/DEF/SPD 各 8-17
- ビジュアル: 完全ランダム

---

## 6. 属性システム

### 6.1 属性一覧

| 属性 | 識別子 | UIカラー |
|---|---|---|
| 炎 | `fire` | #FF6B6B |
| 水 | `water` | #74B9FF |
| 地 | `earth` | #FDCB6E |
| 風 | `wind` | #55EFC4 |
| 光 | `light` | #FFF176 |
| 闇 | `dark` | #AB47BC |

### 6.2 属性決定ロジック

OSバージョン文字列から数字部分のみを抽出し、属性数（6）で剰余を取る。

```
digits = osVersion.replaceAll(非数字, '')
index = int(digits) % 6
element = ElementType.values[index]
```

### 6.3 属性相性

有利属性では1.5倍、不利属性では0.75倍のダメージ倍率が適用される。

```
炎 → 風 → 地 → 光 → 闇 → 水 → 炎（有利方向: 1.5倍）
炎 ← 風 ← 地 ← 光 ← 闇 ← 水 ← 炎（不利方向: 0.75倍）
```

等倍の場合は1.0倍。

---

## 7. ステータスシステム

### 7.1 ステータス項目

| 項目 | 略称 | 説明 |
|---|---|---|
| HP | HP | 体力。0になると戦闘不能 |
| 最大HP | maxHP | HPの上限値 |
| 攻撃力 | ATK | 通常攻撃・スキルのダメージに影響 |
| 防御力 | DEF | 被ダメージ軽減に影響 |
| 素早さ | SPD | 行動順の決定に使用 |

### 7.2 レベルアップ倍率

レベルに応じてステータスが上昇する。

```
倍率 = 1.0 + (level - 1) * 0.1
```

| レベル | 倍率 |
|---|---|
| 1 | x1.0 |
| 2 | x1.1 |
| 5 | x1.4 |
| 10 | x1.9 |
| 11 | x2.0 |

全ステータス（HP/ATK/DEF/SPD）に同一の倍率が適用される。

### 7.3 実効ステータス (effectiveStats)

バトル中の実際のステータスは、バフ・デバフおよびバッテリー補正を反映した値となる。

**バッテリー補正（SPDのみ）**:
```
SPD倍率 += (batteryLevel - 50) * 0.002
```

| バッテリー残量 | SPD補正 |
|---|---|
| 100% | +10% (x1.1) |
| 50% | +0% (x1.0) |
| 0% | -10% (x0.9) |

各倍率の下限は0.1。

---

## 8. スキルシステム

### 8.1 スキルカテゴリ

| カテゴリ | 説明 |
|---|---|
| attack | 敵にダメージを与える攻撃スキル |
| defense | 自身の防御力を強化する防御スキル |
| special | 回復・バフ・デバフなどの特殊スキル |

### 8.2 スキル属性

各スキルは `multiplier`（倍率）、`cooldown`（再使用ターン数）、任意の `StatusEffect`（付与効果）、`isSelfTarget`（自身対象か）を持つ。

### 8.3 属性別スキル一覧

#### 炎属性
| スキル名 | カテゴリ | 倍率 | CT | 効果 |
|---|---|---|---|---|
| ファイアボール | attack | 1.8 | 2 | なし |
| 灼熱の壁 | defense | 0.0 | 4 | 自身DEF+20% (3T) |
| フレイムチャージ | special | 0.0 | 4 | 自身ATK+30% (3T) |

#### 水属性
| スキル名 | カテゴリ | 倍率 | CT | 効果 |
|---|---|---|---|---|
| ウォータースラッシュ | attack | 1.7 | 2 | なし |
| ヒーリングウェーブ | special | 0.4 | 4 | 自身HP回復 (最大HPx倍率) |
| アクアベール | defense | 0.0 | 4 | 自身DEF+25% (3T) |

#### 地属性
| スキル名 | カテゴリ | 倍率 | CT | 効果 |
|---|---|---|---|---|
| ロックスマッシュ | attack | 2.0 | 3 | なし |
| ストーンアーマー | defense | 0.0 | 5 | 自身DEF+40% (3T) |
| アースクエイク | special | 1.2 | 4 | 敵SPD-20% (3T) |

#### 風属性
| スキル名 | カテゴリ | 倍率 | CT | 効果 |
|---|---|---|---|---|
| エアカッター | attack | 1.5 | 1 | なし |
| スピードブースト | special | 0.0 | 3 | 自身SPD+30% (3T) |
| ダウンバースト | special | 1.2 | 4 | 敵ATK-20% (3T) |

#### 光属性
| スキル名 | カテゴリ | 倍率 | CT | 効果 |
|---|---|---|---|---|
| ホーリーレイ | attack | 1.9 | 2 | なし |
| バリア | defense | 0.0 | 4 | 自身DEF+20% (3T) |
| セイントヒール | special | 0.0 | 5 | 自身Regen 15%/T (3T) |

#### 闇属性
| スキル名 | カテゴリ | 倍率 | CT | 効果 |
|---|---|---|---|---|
| シャドウストライク | attack | 2.2 | 3 | なし |
| カースドレイン | special | 0.3 | 4 | 敵にATKx倍率のダメージ＋同量回復 |
| ウィークネス | special | 0.5 | 3 | 敵DEF-25% (3T) |

---

## 9. バフ・デバフシステム

### 9.1 効果タイプ

| タイプ | 分類 | 説明 |
|---|---|---|
| attackUp | バフ | 攻撃力上昇 (%) |
| attackDown | デバフ | 攻撃力低下 (%) |
| defenseUp | バフ | 防御力上昇 (%) |
| defenseDown | デバフ | 防御力低下 (%) |
| speedUp | バフ | 素早さ上昇 (%) |
| speedDown | デバフ | 素早さ低下 (%) |
| poison | デバフ | 継続ダメージ |
| regen | バフ | 継続回復 |
| stun | デバフ | 行動不能 |

### 9.2 効果の管理

- 各効果は `duration`（残りターン数）を持ち、ターン終了時に1ずつ減少
- `duration` が0になると効果は消滅し、ログに通知される
- 同一IDの効果は上書きされる（重複不可）
- `isPermanent` フラグが true の場合、ターン経過で消滅しない

---

## 10. バトルシステム

### 10.1 バトルフロー

1. プレイヤーと敵のバトル用ステータスを初期化（HPを最大値にリセット）
2. 各ターンでSPD（実効値）を比較し、高い方が先攻
3. 各キャラクターが行動を選択・実行
4. ターン終了時にバフ/デバフの残りターン数を減少、クールダウンを減少
5. いずれかのHPが0以下になるか、50ターン経過でバトル終了

### 10.2 行動選択AI

以下の優先度で行動が決定される:

1. **スタン中**: 行動不可（スキップ）
2. **HP < 30%**: 40%の確率で防御を選択
3. **使用可能スキルあり**: 45%の確率でスキル使用（ランダム選択）
4. **その他**: 15%の確率で防御、残りは通常攻撃

### 10.3 ダメージ計算

#### 通常攻撃
```
rawDamage = 攻撃側ATK(実効) * 1.0 * 属性相性倍率 - 防御側DEF(実効) * 0.5
damage = max(1, round(rawDamage))
```

#### 攻撃スキル
```
rawDamage = 攻撃側ATK(実効) * スキル倍率 * 属性相性倍率 - 防御側DEF(実効) * 0.3
damage = max(1, round(rawDamage))
```

最低ダメージは1。

#### 防御
```
回復量 = 最大HP * 5%
```

自身のHPを最大HPの5%回復する。

#### 回復スキル（自身対象）
```
回復量 = 最大HP * スキル倍率
```

#### HP吸収（カースドレイン）
```
ダメージ = ATK(実効) * スキル倍率
回復量 = ダメージと同量
```

### 10.4 バトル結果

| 項目 | 説明 |
|---|---|
| playerWon | プレイヤーの勝敗 |
| turnsPlayed | 経過ターン数 |
| expGained | 獲得経験値 |
| log | バトルログ全体 |

---

## 11. 経験値・レベルシステム

### 11.1 獲得経験値

```
基本値 = 勝利時: 50 / 敗北時: 20
獲得経験値 = 基本値 * (1.0 + (敵レベル - 1) * 0.2)
```

| 敵レベル | 勝利時 | 敗北時 |
|---|---|---|
| 1 | 50 | 20 |
| 5 | 90 | 36 |
| 10 | 140 | 56 |

### 11.2 必要経験値

次のレベルに必要な経験値は以下の式で計算される。

```
必要経験値 = 100 * (1.0 + (level - 1) * 0.5)
```

| レベル | 次レベルまで |
|---|---|
| 1 | 100 |
| 2 | 150 |
| 3 | 200 |
| 5 | 300 |
| 10 | 550 |

経験値が必要量を超えた場合、連続レベルアップが発生する。

---

## 12. データ永続化

`SharedPreferences` を使用してローカルにデータを保存する。

### 保存項目

| キー | 型 | デフォルト値 | 説明 |
|---|---|---|---|
| `level` | int | 1 | 現在レベル |
| `current_exp` | int | 0 | 現在の経験値 |
| `exp_to_next` | int | 100 | 次レベルまでの必要経験値 |
| `battle_count` | int | 0 | 通算バトル数 |
| `win_count` | int | 0 | 通算勝利数 |
| `character_seed` | int | 0 | キャラクターシード値 |

### 保存タイミング

- **リザルト画面表示時**: 経験値の加算と戦績の記録が非同期で実行される
- **ホームに戻る時**: 保存完了を `await` してから画面遷移する

---

## 13. UI/UX

### 13.1 テーマ

- **ベース**: ダークテーマ (`Brightness.dark`)
- **背景色**: #0D1B2A（深い紺色）
- **カード背景**: #1B2838
- **プライマリカラー**: #6C5CE7（紫）
- **セカンダリカラー**: #00B894（緑）
- **フォント**: Roboto

### 13.2 アニメーション

| 場所 | アニメーション | 詳細 |
|---|---|---|
| ホーム画面 | バトルボタンパルス | 0.95〜1.05倍のスケール、2秒周期 |
| バトル画面 | ダメージシェイク | 300ms、弾性カーブ、振幅8px |
| バトル画面 | ダメージポップアップ | 800ms、バウンススケール＋上方移動＋フェードアウト |
| バトル画面 | スキルエフェクト | 1200ms、スケールイン＋フェードイン/アウト |
| リザルト画面 | 結果表示 | 800ms、弾性スケール(0.5→1.0)＋フェードイン |

### 13.3 ウィジェット構成

| ウィジェット | ファイル | 説明 |
|---|---|---|
| `PixelCharacter` | `pixel_character.dart` | CustomPaintによるドット絵キャラ描画 |
| `StatBar` | `stat_bar.dart` | HP/EXP等の比率バー（アニメーション付き） |
| `DamagePopup` | `damage_popup.dart` | ダメージ/回復数値のポップアップ演出 |
| `SkillEffectOverlay` | `skill_effect_overlay.dart` | スキル発動時の全画面オーバーレイ |

---

## 14. アーキテクチャ

### ディレクトリ構成

```
lib/
├── main.dart                          # エントリーポイント
├── data/                              # データ層
│   ├── device_info_service.dart       # デバイス情報取得サービス
│   ├── local_storage_service.dart     # SharedPreferencesラッパー
│   ├── platform_info_native.dart      # ネイティブ環境のPlatform情報
│   └── platform_info_stub.dart        # Web環境のスタブ
├── domain/                            # ドメイン層
│   ├── enums/
│   │   ├── effect_type.dart           # ステータス効果の種類
│   │   └── element_type.dart          # 属性の種類・相性
│   ├── models/
│   │   ├── character.dart             # キャラクターモデル
│   │   ├── experience.dart            # 経験値・レベルモデル
│   │   ├── skill.dart                 # スキルモデル・属性別スキル定義
│   │   ├── stats.dart                 # ステータスモデル
│   │   └── status_effect.dart         # バフ・デバフモデル
│   └── services/
│       ├── battle_engine.dart         # バトルロジック
│       ├── character_generator.dart   # キャラクター生成ロジック
│       └── experience_service.dart    # 経験値管理サービス
└── presentation/                      # プレゼンテーション層
    ├── screens/
    │   ├── home_screen.dart           # ホーム画面
    │   ├── character_screen.dart      # キャラクター詳細画面
    │   ├── battle_screen.dart         # バトル画面
    │   └── result_screen.dart         # リザルト画面
    └── widgets/
        ├── pixel_character.dart       # ドット絵描画ウィジェット
        ├── stat_bar.dart              # ステータスバーウィジェット
        ├── damage_popup.dart          # ダメージポップアップ
        └── skill_effect_overlay.dart  # スキルエフェクト

```

### 状態管理

- `setState` + `AnimatedBuilder` によるシンプルな状態管理
- 外部の状態管理ライブラリは不使用

### 依存パッケージ

| パッケージ | バージョン | 用途 |
|---|---|---|
| `shared_preferences` | ^2.2.0 | ローカルデータ永続化 |
| `battery_plus` | ^7.0.0 | バッテリー残量取得 |
| `cupertino_icons` | ^1.0.8 | iOSスタイルアイコン |